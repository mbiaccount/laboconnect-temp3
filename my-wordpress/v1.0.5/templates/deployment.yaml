apiVersion: v1
kind: Pod
metadata:
  name: httpd
  labels:
    app: LaboConnect
#  namespace: lc
#    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
#    release: "{{ .Release.Name }}"
#    heritage: "{{ .Release.Service }}"
spec:
  containers:
  - name: {{ template "fullname" . }}
    image: "{{ .Values.httpd.repository }}:{{ .Values.httpd.tag }}"
    imagePullPolicy: {{ .Values.httpd.pullPolicy | quote }}
    ports:
    - name: https
      containerPort: 443
      protocol: TCP
    - name: modcluster
      containerPort: 6666
    env:
    - name: HTTPD_VHOST
      value: {{ .Values.node }}
    - name: BDD_HOST
      value: {{ .Values.node }}
    - name: JBOSS_HOST
      value: {{ .Values.node }}
    envFrom:
    - secretRef:
        name: envfile
    volumeMounts:
    - mountPath: /etc/localtime
      name: localtime
  nodeSelector:
    kubernetes.io/hostname: {{ .Values.node }}
  {{- if .Values.httpd.pullSecrets }}
  imagePullSecrets:
  {{- range .Values.httpd.pullSecrets }}
    - name: {{ . }}
  {{- end}}
  {{- end }}
  volumes:
  - name: localtime
    hostPath:
      path: /etc/localtime
---
apiVersion: v1
kind: Pod
metadata:
  name: postgres
  labels:
    app: LaboConnect2
#  namespace: lc
spec:
  containers:
  - name: postgres
    image: "{{ .Values.mariadb.repository }}:{{ .Values.mariadb.tag }}"
    imagePullPolicy: {{ .Values.mariadb.pullPolicy | quote }}
    ports:
    - name: postgres
      containerPort: 5432
    env:
    - name: HTTPD_VHOST
      value: {{ .Values.node }}
    - name: BDD_HOST
      value: {{ .Values.node }}
    - name: JBOSS_HOST
      value: {{ .Values.node }}
    envFrom:
    - secretRef:
        name: envfile
    volumeMounts:
    - name: localtime
      mountPath: /etc/localtime
    - name: zoneinfo
      mountPath: /usr/share/zoneinfo
    - name: postgresql
      mountPath: /var/lib/pgsql/data
  nodeSelector:
    kubernetes.io/hostname: {{ .Values.node }}
  {{- if .Values.httpd.pullSecrets }}
  imagePullSecrets:
  {{- range .Values.httpd.pullSecrets }}
    - name: {{ . }}
  {{- end}}
  {{- end}}
  volumes:
  - hostPath:
      path: "/etc/localtime"
    name: localtime
  - hostPath:
      path: "/usr/share/zoneinfo"
    name: zoneinfo
  - hostPath:
      path: /home/dlsante/dlsante/volumes/laboconnect/LC03.06/postgresql
    name: postgresql
---
kind: Pod
apiVersion: v1
metadata:
  labels:
    app: LaboConnect3
  name: jboss
#  namespace: lc
spec:
  initContainers:
  - name: init-jboss
    image:  "{{ .Values.jboss.repository }}:{{ .Values.jboss.tag }}"
    command: [ 'sh', '-c', 'sleep 35;']
  containers:
  - name: jboss
    image: "{{ .Values.jboss.repository }}:{{ .Values.jboss.tag }}"
    imagePullPolicy: {{ .Values.jboss.pullPolicy | quote }}
    ports:
    - name: postgres
      containerPort: 7070
    env:
    - name: HTTPD_VHOST
      value: {{ .Values.node }}
    - name: BDD_HOST
      value: {{ .Values.node }}
    - name: JBOSS_HOST
      value: {{ .Values.node }}
    envFrom:
    - secretRef:
        name: envfile
    volumeMounts:
    - mountPath: "/etc/localtime"
      name: localtime
    - mountPath: /usr/labo/messages/
      name: messages
    - mountPath: /usr/labo/jboss-eap-6.1/domain/log/
      name: jboss-controller-log
    - mountPath: /usr/labo/jboss-eap-6.1/domain/servers/node1-main-server/log
      name: jboss-log
    - mountPath: /usr/labo/laboconnect/
      name: laboconnect
    - mountPath: /usr/labo/jboss-eap-6.1/modules/system/layers/base/fr/dlsante/settings/laboconnect/main
      name: properties
    - mountPath: /usr/labo/sql
      name: sql
    - mountPath: "/usr/share/zoneinfo"
      name: zoneinfo
    - mountPath: /usr/build
      name: ip
  nodeSelector:
    kubernetes.io/hostname: {{ .Values.node }}
  {{- if .Values.httpd.pullSecrets }}
  imagePullSecrets:
  {{- range .Values.httpd.pullSecrets }}
    - name: {{ . }}
  {{- end}}
  {{- end}}
  volumes:
  - name: localtime
    hostPath:
      path: /etc/localtime
  - name: messages
    hostPath:
      path: /home/dlsante/dlsante/volumes/laboconnect/LC03.06/messages/
  - name: jboss-controller-log
    hostPath:
      path: /home/dlsante/dlsante/volumes/laboconnect/LC03.06/jboss-controller-log/
  - name: jboss-log
    hostPath:
      path: /home/dlsante/dlsante/volumes/laboconnect/LC03.06/jboss-log
  - name: laboconnect
    hostPath:
      path: /home/dlsante/dlsante/volumes/laboconnect/LC03.06/laboconnect/
  - name: properties
    hostPath:
      path: /home/dlsante/dlsante/volumes/laboconnect/LC03.06/properties
  - name: sql
    hostPath:
      path: /home/dlsante/dlsante/volumes/laboconnect/LC03.06/sql
  - name: zoneinfo
    hostPath:
      path: /usr/share/zoneinfo
  - name: ip
    hostPath:
      path: /root/dlsante/volumes/laboconnect/LC03.06/IP
---
apiVersion: v1
kind: Secret
metadata:
  name: envfile
data:
  PASS_LC: UUJ3WjRISmJXdg==
  PASS_MSS_RO: a1VqRWpoTmEyOA==
  PASS_MSS_RW: ZDNUTTk2dlRuMQ==
  HTTPD_HOST: aHR0cGQx
  MESSAGES: ZmFsc2U=
  DOCKER_USER_UID: MTAwMA==
  DOCKER_USER_GID: MTAwMA==
  CXF_LOGGING: dHJ1ZQ==
  POSTGRES_PASSWORD: S3VGTTRMTXlsYg==
  POSTGRES_UID: MTAwMA==
  POSTGRES_GID: MTAwMA==
  VSFTPD_LISTEN_PORT: MTAwMjE=
