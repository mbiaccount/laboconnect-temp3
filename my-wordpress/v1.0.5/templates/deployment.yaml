apiVersion: v1
kind: Pod
metadata:
  name: initvolume{{.Values.numb}}
  labels:
    app: init
spec:
  containers:
  - name: init
    image: initvol:first
    imagePullPolicy: {{ .Values.httpd.pullPolicy | quote }}
    ports:
    - name: init
      containerPort: 6060
    env:
    - name: VERSION_LABO
      value: {{.Values.VersionLaboconnect}}
    - name: VERSION_LABO_TAR
      value: {{.Values.VersionLaboconnect}}.tar.bz2
    volumeMounts:
    - mountPath: /tmp
      name: archive
    - mountPath: /tmp/back
      name: arbo
  restartPolicy: Never
  volumes:
  - name: archive
    hostPath:
      path: /home/dlsante/volumes/archive
  - name: arbo
    hostPath:
      path: {{.Values.arb}}
#  ---------------------------------------------------------------------------------------------------------
---
apiVersion: v1
kind: Pod
metadata:
  name: httpd{{.Values.numb}}
  labels:
    app: LaboConnect
  namespace: lc
spec:
  containers:
  - name: {{ template "fullname" . }}
    image: "{{ .Values.httpd.repository }}:{{ .Values.httpd.tag }}"
    imagePullPolicy: {{ .Values.httpd.pullPolicy | quote }}
    ports:
    - name: https
      containerPort: 443
      protocol: TCP
    - name: modcluster
      containerPort: 6666
    env:
    - name: HTTPD_VHOST
      value: {{ .Values.node }}
    - name: BDD_HOST
      value: {{ .Values.node }}
    - name: JBOSS_HOST
      value: {{ .Values.node }}
    envFrom:
    - secretRef:
        name: envfile
    volumeMounts:
    - mountPath: /etc/localtime
      name: localtime
  nodeSelector:
    kubernetes.io/hostname: {{ .Values.node }}
  {{- if .Values.httpd.pullSecrets }}
  imagePullSecrets:
  {{- range .Values.httpd.pullSecrets }}
    - name: {{ . }}
  {{- end}}
  {{- end }}
  volumes:
  - name: localtime
    hostPath:
      path: /etc/localtime
---
apiVersion: v1
kind: Pod
metadata:
  name: postgres{{.Values.numb}}
  labels:
    app: LaboConnect2
#  namespace: lc
spec:
  initContainers:
  - name: init-postgres
    image: {{.Values.imglight}} 
    imagePullPolicy: {{ .Values.postgres.pullPolicy | quote }}
    command: [ 'sh', '-c', 'sleep 45' ]
  containers:
  - name: postgres
    image: "{{.Values.postgres.repository}}:{{.Values.postgres.tag}}"
    imagePullPolicy: {{ .Values.postgres.pullPolicy | quote }}
    ports:
    - name: postgres
      containerPort: 5432
    env:
    - name: HTTPD_VHOST
      value: {{ .Values.node }}
    - name: BDD_HOST
      value: {{ .Values.node }}
    - name: JBOSS_HOST
      value: {{ .Values.node }}
    - name: POSTGRES_PASSWORD
      value: {{ .Values.postgres.password }}
    - name: PASS_LC
      value: {{.Values.pass_lc }}
    - name: PASS_MSS_RO
      value: {{.Values.pass_ro }}
    - name: PASS_MSS_RW
      value: {{.Values.pass_rw }}
    envFrom:
    - secretRef:
        name: envfile
    volumeMounts:
    - name: localtime
      mountPath: /etc/localtime
    - name: zoneinfo
      mountPath: /usr/share/zoneinfo
    - name: postgresql
      mountPath: /var/lib/pgsql/data
  nodeSelector:
    kubernetes.io/hostname: {{ .Values.node }}
  {{- if .Values.httpd.pullSecrets }}
  imagePullSecrets:
  {{- range .Values.httpd.pullSecrets }}
    - name: {{ . }}
  {{- end}}
  {{- end}}
  volumes:
  - hostPath:
      path: "/etc/localtime"
    name: localtime
  - hostPath:
      path: "/usr/share/zoneinfo"
    name: zoneinfo
  - hostPath:
      path: {{.Values.arb}}{{.Values.VersionLaboconnect}}/postgresql
    name: postgresql
---
kind: Pod
apiVersion: v1
metadata:
  labels:
    app: LaboConnect3
  name: jboss{{.Values.numb}}
#  namespace: lc
spec:
  initContainers:
  - name: init-jboss
    image: {{.Values.imglight}}
    command: [ 'sh', '-c', 'sleep 75']
  containers:
  - name: jboss
    image: "{{ .Values.jboss.repository }}:{{ .Values.jboss.tag }}"
    imagePullPolicy: {{ .Values.jboss.pullPolicy | quote }}
    ports:
    - name: postgres
      containerPort: 7070
    env:
    - name: HTTPD_VHOST
      value: {{ .Values.node }}
    - name: BDD_HOST
      value: {{ .Values.node }}
    - name: JBOSS_HOST
      value: {{ .Values.node }}
    - name: POSTGRES_PASSWORD
      value: {{ .Values.postgres.password }}
    - name: PASS_LC
      value: {{.Values.pass_lc }}
    - name: PASS_MSS_RO
      value: {{.Values.pass_mss_ro }}
    - name: PASS_MSS_RW
      value: {{.Values.pass_mss_rw }}
    envFrom:
    - secretRef:
        name: envfile
    volumeMounts:
    - mountPath: "/etc/localtime"
      name: localtime
    - mountPath: /usr/labo/messages/
      name: messages
    - mountPath: /usr/labo/jboss-eap-6.1/domain/log/
      name: jboss-controller-log
    - mountPath: /usr/labo/jboss-eap-6.1/domain/servers/node1-main-server/log
      name: jboss-log
    - mountPath: /usr/labo/laboconnect/
      name: laboconnect
    - mountPath: /usr/labo/jboss-eap-6.1/modules/system/layers/base/fr/dlsante/settings/laboconnect/main
      name: properties
    - mountPath: /usr/labo/sql
      name: sql
    - mountPath: "/usr/share/zoneinfo"
      name: zoneinfo
  nodeSelector:
    kubernetes.io/hostname: {{ .Values.node }}
  {{- if .Values.httpd.pullSecrets }}
  imagePullSecrets:
  {{- range .Values.httpd.pullSecrets }}
    - name: {{ . }}
  {{- end}}
  {{- end}}
  volumes:
  - name: localtime
    hostPath:
      path: /etc/localtime
  - name: messages
    hostPath:
      path: {{.Values.arb}}{{.Values.VersionLaboconnect}}/messages/
  - name: jboss-controller-log
    hostPath:
      path: {{.Values.arb}}{{.Values.VersionLaboconnect}}/jboss-controller-log/
  - name: jboss-log
    hostPath:
      path: {{.Values.arb}}{{.Values.VersionLaboconnect}}/jboss-log
  - name: laboconnect
    hostPath:
      path: {{.Values.arb}}{{.Values.VersionLaboconnect}}/laboconnect/
  - name: properties
    hostPath:
      path: {{.Values.arb}}{{.Values.VersionLaboconnect}}/properties
  - name: sql
    hostPath:
      path: {{.Values.arb}}{{.Values.VersionLaboconnect}}/sql
  - name: zoneinfo
    hostPath:
      path: /usr/share/zoneinfo
---
apiVersion: v1
kind: Secret
metadata:
  name: envfile{{.Values.numb}}
data:
  #HTTPD_HOST: aHR0cGQx
  MESSAGES: ZmFsc2U=
  DOCKER_USER_UID: MTAwMA==
  DOCKER_USER_GID: MTAwMA==
  CXF_LOGGING: dHJ1ZQ==
  POSTGRES_UID: MTAwMA==
  POSTGRES_GID: MTAwMA==
  VSFTPD_LISTEN_PORT: MTAwMjE=
